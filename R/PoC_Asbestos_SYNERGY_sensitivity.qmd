---
title: "Probability of Causation: SYNERGY sensitivity analysis"
subtitle: "Lung cancer due to occupational asbestos exposure"
author:
  - name: Javier Mancilla-Galindo
    affiliations:
      - ref: iras
  - name: Susan Peters
    affiliations:
      - ref: iras
  - name: Jenny Deng
    affiliations:
      - ref: iras
  - name: Henk van der Molen
    affiliations:
      - ref: amc
  - name: Hans Kromhout
    affiliations:
      - ref: iras
  - name: Lützen Portengen
    affiliations:
      - ref: iras
  - name: Roel Vermeulen
    affiliations:
      - ref: iras
  - name: Dick Heederik
    affiliations:
      - ref: iras
      - ref: lexces
affiliations:
  - id: iras
    name: Institute for Risk Assessment Sciences, Utrecht University
    city: Utrecht
    country: the Netherlands
  - id: amc
    name: Department of Public and Occupational Health, Amsterdam UMC
    city: Amsterdam
    country: the Netherlands
  - id: lexces
    name: National Expertise Centre for Substance-related Occupational Diseases (Lexces)
    city: Utrecht
    country: the Netherlands
date: today
abstract-title: About
abstract: "This report describes sensitivity analyses of the SYNERGY pooled case-control study, by stratifying studies according to the source of controls (hospital-based or population-based), to to estimate the exposure-response relation of lung cancer risk and cumulative exposure to asbestos through meta-analysis of individual participant data (IPD). Three approaches are compared: univariate and bivariate two-stage IPD meta-analysis, and one-stage IPD meta-analysis. Exposure-response relations are used to estimate the exposure threshold at which the likelihood of lung cancer is doubled, corresponding to a probability of causation of 0.5. The upper 95% prediction interval is used as to obtain the exposure thresholds at which it is presumably plausible that lung cancer was caused by asbestos."
execute: 
  echo: false
  warning: false
format:
  pdf: 
    toc: true
    documentclass: scrartcl
    include-in-header:
      text: |
        \usepackage{float}
        \floatplacement{table}{H}
bibliography: ../docs/manuscript/PoC-Asbestos.bib
csl: ../docs/manuscript/european-respiratory-journal.csl
editor: source
---

```{r}
#| label: directories
#| include: false

# Create directories for sub-folders  
inputfolder <- "../data/raw"
psfolder <- "../data/processed"
tempfolder <- "../data/temp"
figfolder <- "../results/output_figures"
tabfolder <- "../results/output_tables"
manuscript_images <- "../docs/manuscript/images"
manuscript_tables <- "../docs/manuscript/tables"

dir.create(inputfolder, showWarnings = FALSE)
dir.create(psfolder, showWarnings = FALSE)
dir.create(tempfolder, showWarnings = FALSE)
dir.create(figfolder, showWarnings = FALSE)
dir.create(tabfolder, showWarnings = FALSE)
dir.create(manuscript_images, showWarnings = FALSE)
dir.create(manuscript_tables, showWarnings = FALSE)
```

```{r}
#| label: install packages
#| eval: false 

options(cli.ignore_unknown_rstudio_theme = TRUE)

if (!require("pak", quietly = TRUE)) {
  install.packages("pak")
}

pak::pkg_install(c(
  "tidyverse",        # Used for basic data handling and visualization.
  "conflicted",       # Resolve conflicts between packages.
  "table1",           # Create table of descriptive characteristics. 
  "flextable",        # Used to render and save table 1. 
  "lme4",             # Linear mixed-effects models.
  "sjPlot",           # Print results of statistical models in html.
  "car",              # Companion to applied regression, used for variance inflation factor.
  "mixmeta",          # Derive exposure-response function based on meta-analysis.
  "metafor",          # Meta-analysis for two-stage MA.
  "splines",          # Natural spline to model exposure-response function.
  "DHARMa",           # Residual diagnostics for mixed models.
  "MASS",             # Functions and datasets for statistical methods.
  "gridExtra",        # Arrange multiple ggplot2 plots.
  "gt",               # Used to print html tables.  
  "report"            # Used to cite packages used in this session.   
))
```

```{r}
#| label: load packages
#| include: false 

if (!require("pacman", quietly = TRUE)) {
  install.packages("pacman")
}

pacman::p_load(
  tidyverse, 
  conflicted, 
  table1, 
  flextable, 
  lme4, 
  sjPlot, 
  car,
  mixmeta, 
  metafor,
  splines, 
  DHARMa, 
  MASS, 
  gridExtra,
  gt,
  report
)

conflicts_prefer(dplyr::filter, dplyr::select)
```

```{r}
#| label: load data
#| include: false  

source("scripts/load_data.R")
```

```{r}
exposed <- df %>% filter(ever_asbestos0 == 1) %>% count %>% pull
cases <- df %>% filter(status == 1) %>% count %>% pull

cases_male <- df %>% filter(status == 1 & sex == "Male") %>% count %>% pull
cases_female <- df %>% filter(status == 1 & sex == "Female") %>% count %>% pull
```

```{r}
PoCfun <- function(logor) {
  OR <- exp(logor)
  pmax((OR-1)/OR,0)
}
```

::: landscape

# Age and sex accross studies 

```{r}
#| fig-pos: "H"
#| fig-align: "center"

source("scripts/create_exposure_summary.R")

age_table <- create_exposure_summary(
  data = df %>% mutate(sex_binary = case_when(sex == "Female" ~ 0, sex == "Male" ~ 1)),
  group_vars = "source_controls",
  binary_var = "sex_binary",
  continuous_var = "age",
  binary_var_label = "Male",
  continuous_var_label = "age",
  continuous_var_unit = "years",
  filter_ever_exposed = FALSE,
  title = "Age and sex by outcome status and source of controls",
  continuous_decimals = 0,
  include_range = FALSE
)

age_table
```


```{r}
#| fig-pos: "H"
#| fig-align: "center"

age_table_study <- create_exposure_summary(
  data = df %>% mutate(sex_binary = case_when(sex == "Female" ~ 0, sex == "Male" ~ 1)),
  group_vars = c("source_controls", "study_name"),
  binary_var = "sex_binary",
  continuous_var = "age",
  binary_var_label = "Male",
  continuous_var_label = "age",
  continuous_var_unit = "years",
  filter_ever_exposed = FALSE,
  title = NULL,
  continuous_decimals = 0,
  include_range = FALSE
)

gtsave(age_table_study, file = file.path(tabfolder, "SYNERGY_age_sex_study.html"))

age_table_study 
```

{{< pagebreak >}}

# Asbestos Exposure accross studies 

```{r}
#| fig-pos: "H"
#| fig-align: "center"

exposure_table <- create_exposure_summary(
  data = df,
  group_vars = "source_controls",
  binary_var = "ever_asbestos0",
  continuous_var = "asbestos_cum0",
  binary_var_label = "Exposed",
  continuous_var_label = "exposure",
  continuous_var_unit = "ff/ml-years",
  title = "Asbestos exposure summary by outcome status and source of controls",
  filter_ever_exposed = TRUE,
  continuous_decimals = 3,
  include_range = TRUE
)

exposure_table
```

```{r}
# Filter to exposed individuals only
df_exposed <- df %>%
  filter(asbestos_dur0 > 0)

# Calculate first year of exposure for each individual
df_exposed <- df_exposed %>%
  mutate(
    first_exp_year = asbestos_lastexp0 - asbestos_dur0,
    last_exp_year = asbestos_lastexp0,
    
    # Measurement period boundaries
    meas_start = 1971,
    meas_end = 2009,
    
    # Calculate overlap with measurement period
    overlap_start = pmax(first_exp_year, meas_start),
    overlap_end = pmin(last_exp_year, meas_end),
    
    # Years of overlap (0 if no overlap)
    years_covered = pmax(0, overlap_end - overlap_start),
    
    # Individual coverage proportion
    individual_coverage = years_covered / asbestos_dur0
  )

# Overall coverage (weighted by duration)
weighted_coverage <- sum(df_exposed$years_covered) / sum(df_exposed$asbestos_dur0) * 100

```

The weighted coverage of measurements (by person-years) was calculated for all asbestos-exposed individuals in SYNERGY. For each individual, the first year of exposure was derived by subtracting duration of exposure from the year of last exposure. The overlap between each individual's exposure period and the SYN-JEM measurement period (1971–2009) was then calculated. Weighted coverage was computed as the sum of all overlapping person-years divided by the total exposed person-years across all individuals, expressed as a percentage. The total weighted coverage in SYNERGY was: `r weighted_coverage %>% round(1)` %

```{r}
#| fig-pos: "H"
#| fig-align: "center"

exposure_table_study <- create_exposure_summary(
  data = df,
  group_vars = c("source_controls", "study_name"),
  binary_var = "ever_asbestos0",
  continuous_var = "asbestos_cum0",
  binary_var_label = "Exposed",
  continuous_var_label = "exposure",
  continuous_var_unit = "ff/ml-years",
  title = NULL,
  filter_ever_exposed = TRUE,
  continuous_decimals = 3,
  include_range = TRUE
)

gtsave(exposure_table_study, file = file.path(manuscript_tables, "TableS2.html"))

exposure_table_study %>% tab_options(
    table.font.size = px(12) 
  )
```

{{< pagebreak >}}

# Smoking accross studies 

```{r}
#| fig-pos: "H"
#| fig-align: "center"

smoking_table <- create_exposure_summary(
  data = df,
  group_vars = "source_controls",
  binary_var = "ever_smok",
  continuous_var = "packyears",
  binary_var_label = "Ever-smoker",
  continuous_var_label = "pack-years",
  continuous_var_unit = "",
  title = "Smoking habits summary by study and outcome status",
  filter_ever_exposed = TRUE,
  continuous_decimals = 1,
  include_range = FALSE
)

smoking_table
```


```{r}
#| fig-pos: "H"
#| fig-align: "center"

smoking_table_study <- create_exposure_summary(
  data = df,
  group_vars = c("source_controls", "study_name"),
  binary_var = "ever_smok",
  continuous_var = "packyears",
  binary_var_label = "Ever-smoker",
  continuous_var_label = "pack-years",
  continuous_var_unit = "",
  title = NULL,
  filter_ever_exposed = TRUE,
  continuous_decimals = 1,
  include_range = TRUE
)

gtsave(smoking_table_study, file = file.path(manuscript_tables, "TableS3.html"))

smoking_table_study %>% tab_options(
    table.font.size = px(12) 
  )
```

:::

{{< pagebreak >}}

# Two-stage meta-analysis 

```{r}
source("scripts/add_case_counts.R")
source("scripts/two_stage_metanalysis_stratified.R")
```

{{< pagebreak >}}

::: landscape

```{r}
beta_coefficients_two_stage_gt %>% 
  cols_hide(columns = Model) %>% 
  cols_width(
    everything() ~ pct(15)
  )
```

:::

{{< pagebreak >}}

# One-stage meta-analysis 

Mixed effects model - cum0 with interaction term:

A mixed-effects logistic regression model is used to estimate the PoC, with `asbestos_cum0` as the main explanatory variable, and adjusted for:

-   The study source of participants (`study_name`)
-   Age category (`agegroup`). The age groups are: \<45, 45–49, 50–54, 55–59, 60–64, 65–69, 70–74, and \> 74 years.
-   Sex (`sex`), female and male.
-   Smoking (`packyrs`), cigarette pack-years.
-   Time since smoking cessation (`time_quit`). The categories are: current smokers; stopping smoking 2–7, 8–15, 16–25, and \>= 26 years before interview/diagnosis; and never-smokers.

Adding random effects with a random intercept for each study source (`study_name`) and random slopes for the exposure (`asbestos_cum0`) within each study source.

An interaction term between `asbestos_cum0` and `source_controls` is included to assess whether the exposure-response relationship differs between hospital and population control studies.


```{r}
#| echo: true  

mod_int <- glmer(
  status ~ asbestos_cum0 * source_controls + 
    agegroup + sex + packyrs + time_quit + 
    (1 + asbestos_cum0 | study_name),
  data    = df,
  family  = binomial,
  nAGQ    = 1
)

saveRDS(mod_int, file = paste0(tempfolder,"/one-stage_selective-random_cum0_source-controls.rds"))
```

```{r}
#| eval: false

summary(mod_int)
```

```{r}
#| fig-width: 7
#| fig-height: 5
#| fig-dpi: 300
#| out-width: "100%"
#| fig-cap: "Simulated residuals for the one-stage meta-analysis model (1000 iterations)"

sim_res <- simulateResiduals(fittedModel = mod_int, n = 1000)

plot(sim_res)
```

Variance inflation factor: 

```{r}
car::vif(mod_int)
```

{{< pagebreak >}}

```{r}
## Fixed-effect coefficients
beta1  <- fixef(mod_int)["asbestos_cum0"] # hospital controls
beta3  <- fixef(mod_int)["asbestos_cum0:source_controlsP"] # diff for population controls

b_H    <- beta1
b_P    <- beta1 + beta3 # hospital + diff for population controls

## Variance–covariance 
V      <- vcov(mod_int)
var_b1 <- V["asbestos_cum0","asbestos_cum0"]
var_b3 <- V["asbestos_cum0:source_controlsP","asbestos_cum0:source_controlsP"]
cov_1_3 <- V["asbestos_cum0","asbestos_cum0:source_controlsP"]

## Random-slope variance (same for both control types)
ran_eff_var <- VarCorr(mod_int)$study_name["asbestos_cum0","asbestos_cum0"]

## total SE for each slope 
SE_H <- sqrt(ran_eff_var + var_b1)                               
SE_P <- sqrt(ran_eff_var + var_b1 + var_b3 + 2*cov_1_3)             

# Calculate prediction interval bounds for each stratum
LB_H <- b_H - 1.96 * SE_H  # hospital lower bound
UB_H <- b_H + 1.96 * SE_H  # hospital upper bound
LB_P <- b_P - 1.96 * SE_P  # population lower bound  
UB_P <- b_P + 1.96 * SE_P  # population upper bound
```


```{r}
source("scripts/add_case_counts.R")

# Create stratified table
beta_coefficients_stratified <- data.frame(
  Model = c("Population controls", "Hospital controls"),
  Risk_per_ffyr_est = c(
    paste0(round((exp(b_P) - 1) * 100, 1), "%"),
    paste0(round((exp(b_H) - 1) * 100, 1), "%")
  ),
  Risk_per_ffyr_PI = c(
    paste0(round((exp(LB_P) - 1) * 100, 1), "% ; ", 
           round((exp(UB_P) - 1) * 100, 1), "%"),
    paste0(round((exp(LB_H) - 1) * 100, 1), "% ; ", 
           round((exp(UB_H) - 1) * 100, 1), "%")
  ),
  Min_exp_50pct_PoC = c(
    round(log(2) / b_P, 2),
    round(log(2) / b_H, 2)
  ),
  Min_exp_conservative = c(
    round(log(2) / UB_P, 2),
    round(log(2) / UB_H, 2)
  )
)

beta_coefficients_stratified <- add_case_counts(
  beta_table = beta_coefficients_stratified,
  data = df
)

beta_coefficients_stratified %>% 
  write.table(., paste0(tabfolder, "/PoC_one-stage-stratified_count_plus50.txt"), sep = "\t")
```


```{r}
#| fig-pos: "H"
#| fig-align: "center"

beta_coefficients_stratified <- beta_coefficients_stratified %>% 
  gt() %>%
  cols_label(
    Model = "Model",
    Risk_per_ffyr_est = "Estimate",
    Risk_per_ffyr_PI = "95% Prediction Interval", 
    Min_exp_50pct_PoC = "Point Estimate",
    Min_exp_conservative = "Presumably Plausible",
    Point_per_10k = "Point Estimate", 
    Presumably_plausible_per_10k = "Presumably Plausible"
  ) %>%
  tab_spanner(
    label = "Risk Increase per Fibre-year",
    columns = c(Risk_per_ffyr_est, Risk_per_ffyr_PI)
  ) %>%
  tab_spanner(
    label = "Min Exposure for 50% PoC (fibre-years)",
    columns = c(Min_exp_50pct_PoC, Min_exp_conservative)
  ) %>%
  tab_spanner(
    label = "Cases per 10,000 above 50% PoC in SYNERGY",
    columns = c(Point_per_10k, Presumably_plausible_per_10k)
  ) %>%
  cols_align(align = "center") %>%
  tab_header(
    title = "Asbestos Exposure-Response by Control Source in SYNERGY population"
  ) %>%
  tab_footnote(
    footnote = "Probability of Causation (PoC)",
    locations = cells_column_spanners(spanners = "Min Exposure for 50% PoC (fibre-years)")
  ) 

beta_coefficients_stratified %>%  
  gtsave(filename = "rtf/PoC_interaction_count_plus50.rtf", path = tabfolder)

beta_coefficients_stratified  %>% 
  cols_width(
    everything() ~ pct(15) 
  ) 
```

```{r}
df <- df %>% 
  mutate(
    ## choose the correct slope & SE for every record
    beta = if_else(source_controls == "P", b_P, b_H),
    SE   = if_else(source_controls == "P", SE_P, SE_H),
    
    ## PoC and its CI
    PoC     = PoCfun(beta * asbestos_cum0),
    PoC_LB  = PoCfun((beta - 1.96*SE) * asbestos_cum0),
    PoC_UB  = PoCfun((beta + 1.96*SE) * asbestos_cum0)
  )
```

```{r}
expo_grid <- expand.grid(
  asbestos_cum0   = seq(0, 65, by = 0.1),          
  source_controls = factor(c("P", "H")) %>% relevel(ref = "P")        
)

## attach slope & SE that belong to each source type
expo_grid <- expo_grid %>% 
  mutate(
    beta = if_else(source_controls == "P", b_P, b_H),
    SE   = if_else(source_controls == "P", SE_P, SE_H),
    
    PoC    = PoCfun(beta * asbestos_cum0),
    PoC_LB = PoCfun((beta - 1.96*SE) * asbestos_cum0),
    PoC_UB = PoCfun((beta + 1.96*SE) * asbestos_cum0)
  )

# Add RR 
expo_grid <- expo_grid %>% 
  mutate(
    # RR calculations (OR ≈ RR for rare outcomes)
    RR = exp(beta * asbestos_cum0),
    RR_LB = exp((beta - 1.96*SE) * asbestos_cum0),
    RR_UB = exp((beta + 1.96*SE) * asbestos_cum0),
    
    # Cap RR_UB for plotting if needed (adjust threshold as needed)
    RR_UB = case_when(RR_UB >= 6 ~ 6, TRUE ~ RR_UB),
    RR_LB = case_when(RR_LB <= 1 ~ 1, TRUE ~ RR_LB),
    
    # Create labels for plotting
    Study_type = case_when(
      source_controls == "H" ~ "Hospital controls",
      source_controls == "P" ~ "Population controls"
    )
  )

# Save data 
expo_grid %>% 
  write.table(., paste0(tempfolder, "/sensitivity_grid.txt"), sep = "\t")
```

Refer to the ***save_plots.R*** script in the **R/scripts** directory for the relevant code used to generate the plots from this sensitivity analysis. 

{{< pagebreak >}}

::: landscape

# Summary of coefficients

Coefficients from both the ECHA and the SYNERGY study are summarized with the following code. 

```{r}
#| echo: true
source("scripts/summary_coefficients.R")
```

```{r}
#| fig-pos: "H"
#| fig-align: "center"

beta_coefficients_combined_gt %>% 
  cols_width(
    everything() ~ pct(15) 
  ) 
```

# Comparison of SYNERGY meta-analyses

```{r}
beta_coefficients_S3_combined_gt %>% 
  cols_width(
    everything() ~ pct(15) 
  ) 
```


:::

{{< pagebreak >}}

# Package References

For specific information on the operating system, R version, and R package versions used, please refer to the **R/session** folder in the GitHub repository.

```{r}
#| label: session
# remove clutter
session <- sessionInfo()
session$BLAS <- NULL
session$LAPACK <- NULL
session$loadedOnly <- NULL
# write log file
writeLines(
  capture.output(print(session, locale = FALSE)),
  paste0("sessions/",lubridate::today(), "_PoC_Asbestos_SYNERGY_sensitivity.txt")
)                                   
```

```{r}
#| output: asis
report::cite_packages(session)
```

```{r}
#| include: false

# Run this chunk if you wish to clear your environment and unload packages.

pacman::p_unload(negate = TRUE)

rm(list = ls())
```
